name: 🐌 Snailicide Release
run-name: ${{ github.actor }} is testing out GitHub Actions 🚀

on:
    push:
        branches:
            - 'main'

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
    setup:
        uses: ./.github/workflows/setup-node-pnpm.yml
        with:
            install: true
            build: true
            fix: true
            test: true
            check: true
            DEBUG: false

    validate:
        name: 🚨 Validate cleanliness
        runs-on: ubuntu-latest
        needs: setup
        steps:
            - name: 🧼 Check for dirty repo state
              run: |
                  if [[ "${{ needs.setup.outputs.dirty }}" == "true" ]]; then
                    echo "🛑 Dirty files detected on main — CI will now fail."
                    exit 1
                  else
                    echo "✅ Repo is clean, continuing."
                  fi

    release:
        name: 🚀 Release (only if clean)
        runs-on: ubuntu-latest
        needs: [setup, validate]
        if: needs.setup.outputs.dirty == 'false'
        permissions:
            contents: write
            pull-requests: write
            repository-projects: write

        steps:
            - name: Create Release Pull Request
              uses: changesets/action@v1
              with:
                  commit: 'release(root): this commit was created by changesets'
              env:
                  HUSKY: 0
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Tag Versions 🏷️
              run: |
                  pnpm changeset tag
                  git push origin --tags

            - run: echo "🍏 This job's status is ${{ job.status }}."
